<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Pulse PRO: Dynamic Intelligence</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* GitHub Dark Background */
        }
        .card {
            background-color: #161b22; /* Slightly Lighter Card Background */
            border: 1px solid #2f3a4b;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        .pulse-animation {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        /* Live Ticker Styling */
        .ticker-wrap {
            overflow: hidden;
            white-space: nowrap;
            box-sizing: content-box;
            background-color: #0b0f14;
        }
        .ticker-move {
            display: inline-block;
            animation: ticker 25s linear infinite;
            padding-left: 100%;
        }
        @keyframes ticker {
            0% { transform: translate3d(0, 0, 0); }
            100% { transform: translate3d(-100%, 0, 0); }
        }
    </style>
</head>
<body class="text-gray-100 min-h-screen">

    <!-- Live Ticker Strip -->
    <div class="ticker-wrap border-b border-teal-600 shadow-xl">
        <div id="live-ticker" class="ticker-move text-sm sm:text-base font-medium py-2">
            <!-- Ticker content injected here -->
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-8">
        <!-- Header / Hero Section -->
        <header class="text-center mb-10 p-6 rounded-xl bg-gradient-to-r from-gray-900 to-gray-800 shadow-inner">
            <h1 class="text-6xl font-extrabold tracking-tighter text-teal-400">
                Pulse PRO
            </h1>
            <p class="mt-3 text-gray-400 text-2xl font-light max-w-2xl mx-auto">
                Grounded Intelligence. Real-time Market Context.
            </p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Left Column: Live Market Data & Charting -->
            <aside class="lg:col-span-1 space-y-8">
                
                <!-- Dynamic Price Chart (UPDATED FEATURE) -->
                <div class="card p-6 rounded-xl border-l-4 border-pink-500">
                    <h3 class="text-xl font-bold mb-4 text-gray-200 flex items-center">
                        <i data-lucide="line-chart" class="w-5 h-5 mr-2 text-pink-400"></i> <span id="chart-title">SPX Price Trend (Last 50s)</span>
                    </h3>

                    <div class="flex gap-2 mb-4">
                        <input
                            type="text"
                            id="chartSymbolInput"
                            placeholder="e.g., GOOG, NDQ"
                            class="w-24 p-2 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 placeholder:text-gray-500 uppercase text-sm"
                            value="SPX"
                        />
                        <button
                            id="updateChartButton"
                            onclick="updateChartSymbol()"
                            class="bg-gray-700 hover:bg-gray-600 text-teal-400 text-sm font-medium py-2 px-3 rounded-lg transition duration-300"
                        >
                            View
                        </button>
                    </div>

                    <canvas id="dynamicChart" width="300" height="150" class="w-full"></canvas>
                    <p id="chart-error" class="text-xs text-red-400 mt-2 hidden">Symbol not found in simulated data.</p>
                </div>
                
                <!-- Market Sentiment Indicator -->
                <div class="card p-5 rounded-xl border-l-4 border-yellow-500">
                    <h3 class="text-xl font-bold mb-3 text-gray-200 flex items-center">
                        <i data-lucide="gauge" class="w-5 h-5 mr-2 text-yellow-400"></i> Current Market Sentiment
                    </h3>
                    <div id="sentiment-display" class="text-center">
                        <!-- Sentiment will be injected here -->
                    </div>
                </div>

                <!-- Simulated Live Market Prices -->
                <div class="card p-6 rounded-xl border-l-4 border-teal-500">
                    <h3 class="text-2xl font-bold mb-4 text-gray-200 flex items-center">
                        <i data-lucide="trending-up" class="w-5 h-5 mr-2 text-teal-400"></i> Market Watch (Simulated)
                    </h3>
                    <div id="market-prices" class="space-y-3">
                        <!-- Simulated data cards will be injected here -->
                    </div>
                    <p class="text-xs text-gray-500 mt-4">*Prices update every second for live market simulation.</p>
                </div>
            </aside>

            <!-- Right Column: AI Analysis & Control Panel -->
            <section class="lg:col-span-2 space-y-8">
                
                <!-- Input and Control Panel -->
                <div class="card p-6 rounded-xl shadow-2xl">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-200 flex items-center">
                        <i data-lucide="search" class="w-6 h-6 mr-3 text-pink-400"></i> Grounded Analysis Query
                    </h2>
                    <div class="flex flex-col gap-4">
                        <input
                            type="text"
                            id="topicInput"
                            placeholder="Enter stock, sector, or market topic (e.g., 'Google earnings' or 'Crude Oil futures')"
                            class="flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-gray-100 placeholder:text-gray-500 focus:ring-teal-500 focus:border-teal-500 transition duration-300"
                            value="Latest S&P 500 performance and tech stock news"
                        />
                        <button
                            id="fetchButton"
                            onclick="fetchMarketNews()"
                            class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out shadow-lg shadow-teal-500/50 flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i>
                            Run Pulse Analysis
                        </button>
                    </div>
                </div>

                <!-- News Result Panel -->
                <div id="resultsPanel" class="card p-6 rounded-xl shadow-2xl transition duration-500 min-h-[400px]">
                    <div class="flex justify-between items-start mb-4">
                        <h2 class="text-2xl font-semibold text-gray-200 flex items-center">
                            <i data-lucide="book-open" class="w-6 h-6 mr-3 text-blue-400"></i> AI Market Report
                        </h2>
                        <!-- Risk/Impact Assessment Display (NEW FEATURE) -->
                        <div id="risk-rating" class="p-2 rounded-full text-lg font-bold">
                            <!-- Rating will be injected here -->
                        </div>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loading" class="hidden flex flex-col items-center justify-center h-full py-16">
                        <div class="pulse-animation w-10 h-10 border-4 border-t-4 border-t-teal-500 border-gray-600 rounded-full animate-spin"></div>
                        <p id="loading-text" class="mt-4 text-teal-400 font-medium">Analyzing market data...</p>
                    </div>

                    <!-- Content Display -->
                    <div id="newsContent">
                        <p class="text-gray-400 italic">Enter a market topic above and click 'Run Pulse Analysis' to get a real-time summary from top financial news sources, verified by Google Search Grounding.</p>
                    </div>

                    <!-- Sources/Citations -->
                    <div id="sourcesArea" class="mt-6 pt-4 border-t border-gray-700 hidden">
                        <h3 class="text-lg font-medium mb-2 text-gray-300">Sources (Grounded Content)</h3>
                        <div id="sourcesList" class="text-sm space-y-1">
                            <!-- Sources will be injected here -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script type="module">
        // --- Firebase Setup (Kept for environment compatibility) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let auth, db, app;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            const signInPromise = initialAuthToken 
                ? signInWithCustomToken(auth, initialAuthToken) 
                : signInAnonymously(auth);
            signInPromise.catch(error => console.error("Firebase Auth Error:", error));
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }
        // --- End Firebase Setup ---

        // Global UI elements
        const fetchButton = document.getElementById('fetchButton');
        const topicInput = document.getElementById('topicInput');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const newsContent = document.getElementById('newsContent');
        const sourcesArea = document.getElementById('sourcesArea');
        const sourcesList = document.getElementById('sourcesList');
        const marketPricesEl = document.getElementById('market-prices');
        const tickerEl = document.getElementById('live-ticker');
        const sentimentDisplay = document.getElementById('sentiment-display');
        const riskRatingEl = document.getElementById('risk-rating');
        
        // --- Dynamic Charting Elements and History ---
        const chartSymbolInput = document.getElementById('chartSymbolInput');
        const chartTitleEl = document.getElementById('chart-title');
        const chartErrorEl = document.getElementById('chart-error');
        const dynamicChartCanvas = document.getElementById('dynamicChart');
        const dynamicChartCtx = dynamicChartCanvas.getContext('2d');
        
        // History map: Stores up to 50 price points for each stock
        let stockHistory = {}; 
        let selectedChartSymbol = 'SPX'; 
        // ----------------------------------------

        // --- GEMINI API Configuration (API Key is hardcoded) ---
        const API_KEY = ""; 
        const FULL_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        // --- END API Configuration ---

        // --- Simulated Market Data (Live Trading Rate Feature) ---
        let STOCKS = [
            { symbol: 'SPX', name: 'S&P 500', price: 5200.55, change: 0.05, trend: 'up' },
            { symbol: 'NDQ', name: 'NASDAQ 100', price: 18500.89, change: 0.45, trend: 'up' },
            { symbol: 'DJI', name: 'Dow Jones', price: 38800.12, change: -0.15, trend: 'down' },
            { symbol: 'AIG', name: 'AI Global Inc.', price: 175.30, change: 1.25, trend: 'up' },
            { symbol: 'GOOG', name: 'Alphabet Inc.', price: 185.00, change: -0.90, trend: 'down' },
            { symbol: 'OIL', name: 'Crude Oil Futures', price: 82.50, change: -0.75, trend: 'down' },
            { symbol: 'EURUSD', name: 'Euro/USD', price: 1.0850, change: 0.003, trend: 'up' },
        ];
        
        // Initialize history for all stocks
        STOCKS.forEach(stock => {
            stockHistory[stock.symbol] = [];
        });

        // Function to update the chart symbol based on user input
        window.updateChartSymbol = function() {
            const inputSymbol = chartSymbolInput.value.trim().toUpperCase();
            if (STOCKS.some(s => s.symbol === inputSymbol)) {
                selectedChartSymbol = inputSymbol;
                chartTitleEl.textContent = `${inputSymbol} Price Trend (Last 50s)`;
                chartErrorEl.classList.add('hidden');
                // Redraw immediately with the new history data
                drawChart(dynamicChartCtx, stockHistory[selectedChartSymbol] || []); 
            } else {
                chartErrorEl.textContent = `Symbol "${inputSymbol}" not found in simulated list.`;
                chartErrorEl.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function getSentiment(totalChange) {
            if (totalChange > 1.5) {
                return { label: 'Strongly Bullish', color: 'text-green-500', icon: 'zap', bg: 'bg-green-800/50', description: 'Strong upward momentum across key indices.' };
            } else if (totalChange > 0) {
                return { label: 'Bullish', color: 'text-green-400', icon: 'trending-up', bg: 'bg-green-700/50', description: 'Overall market showing positive gains.' };
            } else if (totalChange > -1.5) {
                return { label: 'Neutral/Mixed', color: 'text-yellow-400', icon: 'align-center', bg: 'bg-yellow-700/50', description: 'Consolidation, mixed signals, or low volatility.' };
            } else {
                return { label: 'Bearish', color: 'text-red-400', icon: 'trending-down', bg: 'bg-red-700/50', description: 'Downward pressure on major stocks and indices.' };
            }
        }
        
        // --- Chart Drawing Function (Uses selected history) ---
        function drawChart(ctx, data) {
            const width = ctx.canvas.width;
            const height = ctx.canvas.height;
            const padding = 10;
            const availableHeight = height - padding * 2;
            const availableWidth = width - padding * 2;

            ctx.clearRect(0, 0, width, height);

            if (data.length < 2) {
                 ctx.fillStyle = '#4b5563';
                 ctx.font = '14px Inter';
                 ctx.fillText('Gathering price data...', width / 2 - 70, height / 2);
                 return;
            }

            // Find min/max price for scaling
            const prices = data.map(d => d.price);
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const priceRange = maxPrice - minPrice;
            const scaleY = priceRange > 0 ? availableHeight / priceRange : 0;
            const scaleX = availableWidth / (data.length - 1);

            // Draw the line chart
            ctx.beginPath();
            ctx.lineWidth = 2;
            // Determine line color based on the latest trend
            ctx.strokeStyle = data[data.length - 1].trend === 'up' ? '#10b981' : '#ef4444'; 

            data.forEach((point, index) => {
                const x = padding + index * scaleX;
                const y = height - padding - ((point.price - minPrice) * scaleY);

                if (index === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });

            ctx.stroke();

            // Draw the latest price point circle
            const lastPoint = data[data.length - 1];
            const lastX = padding + (data.length - 1) * scaleX;
            const lastY = height - padding - ((lastPoint.price - minPrice) * scaleY);
            ctx.fillStyle = ctx.strokeStyle;
            ctx.beginPath();
            ctx.arc(lastX, lastY, 3, 0, Math.PI * 2, true);
            ctx.fill();
        }
        // ------------------------------------

        function updateSimulatedData() {
            marketPricesEl.innerHTML = '';
            tickerEl.innerHTML = '';
            let tickerContent = '';
            let totalMarketChange = 0;

            STOCKS.forEach(stock => {
                const direction = Math.random() > 0.5 ? 1 : -1;
                // Higher volatility for lower-priced assets (like OIL, EURUSD)
                const volatility = Math.random() * (stock.price > 100 ? 1.0 : 0.01); 
                const priceMovement = direction * volatility;
                
                stock.price += priceMovement;
                stock.price = Math.max(0.0001, stock.price);
                
                // Simulated change for display (normalized)
                const displayChange = (priceMovement * (stock.price > 100 ? 1 : 100)).toFixed(2);
                stock.trend = priceMovement > 0 ? 'up' : 'down';
                totalMarketChange += parseFloat(displayChange);

                const displayPrice = stock.price.toFixed(stock.price < 10 ? 4 : 2);
                const changeColor = stock.trend === 'up' ? 'text-green-500' : 'text-red-500';
                const trendIcon = stock.trend === 'up' ? 
                    '<i data-lucide="arrow-up-right" class="w-4 h-4 text-green-500"></i>' :
                    '<i data-lucide="arrow-down-right" class="w-4 h-4 text-red-500"></i>';

                // --- CHART DATA COLLECTION ---
                // Ensure history array exists
                if (!stockHistory[stock.symbol]) {
                    stockHistory[stock.symbol] = [];
                }

                // Add data point
                stockHistory[stock.symbol].push({ price: stock.price, trend: stock.trend });
                // Limit history to 50 points
                if (stockHistory[stock.symbol].length > 50) { 
                    stockHistory[stock.symbol].shift();
                }
                // -----------------------------

                // Market Prices Card HTML
                marketPricesEl.innerHTML += `
                    <div class="flex justify-between items-center p-3 rounded-lg hover:bg-gray-800 transition border-b border-gray-700 last:border-b-0">
                        <div>
                            <p class="font-semibold text-lg text-gray-200">${stock.symbol}</p>
                            <p class="text-xs text-gray-500">${stock.name}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-bold ${changeColor}">${displayPrice}</p>
                            <div class="flex items-center justify-end space-x-1 mt-1">
                                ${trendIcon}
                                <span class="text-sm font-medium ${changeColor}">${displayChange}%</span>
                            </div>
                        </div>
                    </div>
                `;

                // Ticker Content 
                tickerContent += `
                    <span class="inline-block px-8 text-gray-400">
                        ${stock.symbol}: <span class="font-bold ${changeColor}">${displayPrice}</span> 
                        <span class="${changeColor} font-medium">(${displayChange}%)</span>
                    </span>
                    <span class="inline-block text-gray-700 px-2">|</span>
                `;
            });
            
            // --- CHART DRAWING (Uses currently selected symbol's history) ---
            if (stockHistory[selectedChartSymbol]) {
                drawChart(dynamicChartCtx, stockHistory[selectedChartSymbol]);
            }
            // ------------------------------------

            // Update Ticker
            tickerEl.innerHTML = tickerContent.repeat(5); 

            // Update Sentiment Indicator
            const sentiment = getSentiment(totalMarketChange);
            sentimentDisplay.innerHTML = `
                <div class="flex flex-col items-center p-3 rounded-xl ${sentiment.bg}">
                    <i data-lucide="${sentiment.icon}" class="w-10 h-10 ${sentiment.color} mb-2"></i>
                    <p class="text-2xl font-extrabold ${sentiment.color}">${sentiment.label}</p>
                    <p class="text-sm text-gray-400 mt-1">${sentiment.description}</p>
                </div>
            `;
            
            // Re-render icons after DOM updates
            lucide.createIcons();
        }

        // Start the simulated data update loop
        setInterval(updateSimulatedData, 1000);
        updateSimulatedData(); // Initial call
        // --- End Simulated Market Data ---

        /**
         * Utility to introduce exponential backoff for API retries.
         */
        async function makeApiCallWithBackoff(payload, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(FULL_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + (Math.random() * 500);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }

                    if (!response.ok) {
                        const errorBody = await response.json();
                        throw new Error(`API call failed with status ${response.status}: ${errorBody.error?.message || response.statusText}`);
                    }

                    return response.json();

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error);
                    if (i === maxRetries - 1) throw error;
                }
            }
        }
        
        /**
         * NEW FEATURE: Second LLM call to get Risk/Impact Rating based on the summary.
         */
        async function getRiskRating(summaryText) {
            loadingText.textContent = 'Assessing market impact...';
            
            const systemPrompt = `Analyze the following financial news summary. Assign a single risk/impact level from HIGH, MEDIUM, or LOW, based on the potential volatility this news could cause across the broad market or the targeted sector. Return ONLY a JSON object.`;
            
            const payload = {
                contents: [{ parts: [{ text: `News Summary to rate: ${summaryText}` }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "impact": { 
                                "type": "STRING", 
                                "enum": ["HIGH", "MEDIUM", "LOW"] 
                            }
                        },
                        "propertyOrdering": ["impact"]
                    }
                }
            };

            try {
                const result = await makeApiCallWithBackoff(payload);
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (jsonText) {
                    const parsed = JSON.parse(jsonText);
                    return parsed.impact || 'UNKNOWN';
                }
            } catch (error) {
                console.error("Risk Rating API Error:", error);
                return 'ERROR';
            }
            return 'UNKNOWN';
        }


        window.fetchMarketNews = async function() {
            const topic = topicInput.value.trim();
            if (!topic) {
                newsContent.innerHTML = '<p class="text-red-400 font-bold">Please enter a market topic to analyze.</p>';
                sourcesArea.classList.add('hidden');
                return;
            }

            // UI state: Disable button, show loading
            fetchButton.disabled = true;
            loading.classList.remove('hidden');
            newsContent.innerHTML = '';
            sourcesArea.classList.add('hidden');
            riskRatingEl.innerHTML = '';
            
            // --- STEP 1: Grounded Analysis ---
            loadingText.textContent = 'Analyzing market data...';

            const analysisSystemPrompt = `You are a professional financial news analyst for a top-tier trading platform. Summarize the current market trends, major stock movements, and most critical recent trading news (in a maximum of five concise paragraphs) related to the user's query: "${topic}". Provide deeper insights and potential future impacts. Maintain an objective, informative, and urgent tone. Do not use conversational phrasing.`;
            
            const analysisPayload = {
                contents: [{ parts: [{ text: topic }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: analysisSystemPrompt }] },
            };

            let generatedText = null;
            let sources = [];

            try {
                const result = await makeApiCallWithBackoff(analysisPayload);
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    generatedText = candidate.content.parts[0].text;
                    
                    // Extract Grounding Sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({ uri: attribution.web?.uri, title: attribution.web?.title }))
                            .filter(source => source.uri && source.title);
                    }
                }

                if (!generatedText) throw new Error("Could not generate news summary.");

            } catch (error) {
                console.error("Global fetch error (Analysis):", error);
                newsContent.innerHTML = `<p class="text-red-400 font-bold">Analysis failed. An error occurred while fetching the data. ${error.message}</p>`;
                loading.classList.add('hidden');
                fetchButton.disabled = false;
                return;
            }
            
            // --- STEP 2: Risk/Impact Assessment ---
            const riskRating = await getRiskRating(generatedText);
            
            // --- STEP 3: Update UI with both results ---
            
            // Update Risk Rating UI
            let ratingColor = 'bg-gray-700 text-gray-300';
            if (riskRating === 'HIGH') {
                ratingColor = 'bg-red-800 text-red-300 ring-4 ring-red-500/50';
            } else if (riskRating === 'MEDIUM') {
                ratingColor = 'bg-yellow-700 text-yellow-300 ring-4 ring-yellow-500/50';
            } else if (riskRating === 'LOW') {
                ratingColor = 'bg-green-800 text-green-300 ring-4 ring-green-500/50';
            }
            
            riskRatingEl.className = `p-2 rounded-full text-sm font-bold shadow ${ratingColor}`;
            riskRatingEl.textContent = `Risk: ${riskRating}`;

            // Update News Content UI
            const formattedText = generatedText.split('\n').filter(p => p.trim() !== '').map(p => 
                `<p class="mb-4 leading-relaxed">${p.trim()}</p>`
            ).join('');
            newsContent.innerHTML = `<div class="text-gray-200">${formattedText}</div>`;

            // Update Sources UI
            if (sources.length > 0) {
                sourcesList.innerHTML = sources.map((source, index) => 
                    `<div class="flex items-start text-sm"><i data-lucide="link" class="w-4 h-4 text-teal-400 mr-2 mt-1 flex-shrink-0"></i><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-teal-400 transition underline truncate">${source.title}</a></div>`
                ).join('');
                sourcesArea.classList.remove('hidden');
            } else {
                sourcesList.innerHTML = '<p class="text-gray-500 italic">No direct sources were found for this summary.</p>';
                sourcesArea.classList.remove('hidden');
            }

            // Final UI state cleanup
            loading.classList.add('hidden');
            fetchButton.disabled = false;
            lucide.createIcons();
        }
    </script>
</body>
</html>
